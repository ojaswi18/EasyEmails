{% extends 'base.html' %}
{% block title %}emailbody{% endblock title %}
{% block body %}
<div class="container-lg p-4" style="background-color:#f2f1f1">
  <div class="icons" style="font-size:15px">
    <i class="bi bi-arrow-left mr-3 p-2" onclick="window.history.back()"></i> 
    <i class="bi bi-trash mr-3 p-2" onclick="deleteEmail('{{ email.id }}')"></i> 
    <i class="bi bi-calendar-event mr-3 p-2"></i> 
    <i class="bi bi-envelope mr-3 p-2"></i> 
    <i class="bi bi-three-dots mr-3 p-2"></i> 
  </div><div class="dropdown-divider"></div>
  <span style=" font-size: 32px;">{{email.subject}}</span><br><br><br>
  <div class="container p-3" style="background-color: #f3f3f3;">
    <div class="p-3" style="display: flex ; flex-direction: row;">
      <div class="first" style="font-size: 23px;">{{email.sender}}</div>
      <div class="second" style="margin-left: auto;">
        {{email.day_month}}
        <button id="star-button-{{ email.id }}" class="star-button ml-2 mr-2" onclick="toggleIcon('{{ email.id }}')" style="border: none; background-color: transparent;">
          <i id="star-icon1-{{ email.id }}" class="bi bi-star" style="display: {% if email.star %}none{% endif %};"></i>
          <i id="star-icon2-{{ email.id }}" class="bi bi-star-fill"  style="display: {% if not email.star %}none{% endif %}; color: yellow;"></i>
       </button>  
       <button class="reply-button mr-2" style="border: none; background-color: transparent;">
        <i class="bi bi-reply"></i>
       </button>
       <span class="dropdown">
        <button class="more-button" type="button" id="moreOptionsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border: none; background-color: transparent;">
          <i class="bi bi-three-dots"></i>
        </button>
        <div class="dropdown-menu" aria-labelledby="moreOptionsDropdown">
          {% comment %} <a class="dropdown-item" href="#">Reply</a> {% endcomment %}
          <a class="dropdown-item" href="#" onclick="replyToEmail('{{ email.id }}')">Reply</a>
          <a class="dropdown-item" onclick="forwardEmail('{{ email.id }}')">Forward</a>
          <a class="dropdown-item" href="#">Delete</a>
          <a class="dropdown-item" href="#">Mark as Unread</a>
          <a class="dropdown-item" href="#">Block</a>
        </div>
      </span>
      </div>
    </div><br>
    <div class="email-body mt-2 mr-5 ml-5" style="overflow-y: auto;">
      {{ email.body|safe }}
    </div> </div> 
  </div>
  {% comment %} <div id="forwardModal" class="modal" style="display: none;">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Forward Email</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Please enter recipient's email address:</p>
          <input type="text" id="recipientEmail" class="form-control" placeholder="Enter recipient's email">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="forwardEmail('{{ email.id }}')">Submit</button>
        </div>
        <div class="modal" tabindex="-1" id="replyModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Reply to Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <textarea id="replyText" class="form-control" placeholder="Enter your reply..."></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendReply">Send Reply</button>
              </div>
            </div>
          </div>
        </div> {% endcomment %}
            <!-- Forward Email Modal Here... -->
    <div id="forwardModal" class="modal" style="display: none;">
      <!-- Modal content here... -->
    </div>

    <!-- Reply Modal Here -->
    {% comment %} <div class="modal" tabindex="-1" id="replyModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Reply to Email</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea id="replyText" class="form-control" placeholder="Enter your reply..."></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="sendReply">Send Reply</button>
          </div>
        </div>
      </div>
    </div>
  </div>  {% endcomment %}
  <div class="modal" tabindex="-1" id="replyModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reply to Email</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <textarea id="replyText" class="form-control" placeholder="Enter your reply..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sendReply">Send Reply</button>
        </div>
      </div>
    </div>
  </div>
      </div>
    </div>
  </div>
</div>
<script>
  function toggleIcon(emailId) {
    var starIcon1 = document.getElementById('star-icon1-' + emailId);
    var starIcon2 = document.getElementById('star-icon2-' + emailId);
    starIcon1.style.display = starIcon1.style.display === 'none' ? 'inline' : 'none';
    starIcon2.style.display = starIcon2.style.display === 'none' ? 'inline' : 'none';

    var isStarred = starIcon2.style.display === 'inline';

    fetch(`/starEmail/${emailId}/`)
    .then(response => response.json())
       
    .then(data => {
      // Alert message
      if (isStarred) {
        alert('Email has been unstarred.');
      } else {
        alert('Email has been starred.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
}
function deleteEmail(emailId) {
  fetch(`/deleteEmail/${emailId}/`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}' // Add the CSRF token for security
    }
  })
  .then(response => {
    if (response.ok) {
      // Email successfully deleted
      const emailElement = document.getElementById('email-' + emailId); 
      console.log('email-' + emailId)
      console.log(emailElement)
      if (emailElement) {
        console.log("to remove element")
        emailElement.remove(); // Remove the email element from the DOM
      }
      
      alert('Email deleted successfully.');
      
      // Redirect to another page or perform any other necessary action
      // window.location.href = '/emails'; // Replace with your desired URL
    } else {
      // Error occurred while deleting the email
      
      alert('Error deleting email.');
    }
  })
  .catch(error => {
    // Error occurred while making the request
    console.error('Error:', error);
  });
}

  // Forward the email using the recipient's email address
  function forwardEmail(emailId) {
    var recipientEmail = prompt("Please enter recipient's email address:");
    if (recipientEmail != null) {
      // This assumes recipientEmail does not contain any characters that are illegal in a URL.
      window.location.href = '/forward/' + emailId + '/' + recipientEmail + '/';
    }
}

{% comment %} function replyToEmail(emailId) {
  var replyText = prompt("Please enter your reply:");

  if (replyText != null && replyText != "") {
      // This assumes replyText does not contain any characters that are illegal in a URL.
      window.location.href = '/reply/' + emailId + '/' + encodeURIComponent(replyText) + '/';
  }
} {% endcomment %}

function replyToEmail(emailId) {
  document.getElementById('sendReply').onclick = function() {
    var replyText = document.getElementById('replyText').value;
    if (replyText != "") {
      // This assumes replyText does not contain any characters that are illegal in a URL.
      window.location.href = '/reply/' + emailId + '/' + encodeURIComponent(replyText) + '/';
    }
  };
  var modal = new bootstrap.Modal(document.getElementById('replyModal'));
  modal.show();
}


</script>
{% endblock body %}



